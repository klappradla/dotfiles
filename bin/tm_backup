#!/bin/bash
readonly WORKING_DIR="$(dirname "${BASH_SOURCE[0]}")"

source "$WORKING_DIR/backup.conf"

readonly NAS=$NAS_ADDRESS
readonly TODAY="$(date +'%F')"
readonly LAST_RUN_FILE="$WORKING_DIR/.last_tm_backup.txt"
readonly DEST_ID=$TM_DEST

backup_ran() {
  [ -e $LAST_RUN_FILE ] &&
    grep -Fxq "$TODAY" "$LAST_RUN_FILE"
}

tm_backup() {
  nas_available &&
  tmutil startbackup --destination $DEST_ID &&
  write_log
}

write_log() {
  echo "$TODAY" > "$LAST_RUN_FILE"
}

nas_available() {
  nc -z $NAS 22 > /dev/null
}

main() {
  backup_ran || tm_backup
}
main
